<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Kubernetes | Blog of James Brown</title>
  <meta name="author" content="James Brown">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Blog of James Brown"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/blog/atom.xml" title="Blog of James Brown" type="application/atom+xml">
  
  
    <link href="/blog/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/blog/css/themes/cerulean.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/blog/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/blog/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/blog/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/blog/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/blog/css/highlight-default.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/blog/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/blog/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  <![endif]-->

  <script src="/blog/js/jquery-2.0.3.min.js"></script>
  
  
  <!-- analytics -->
  



<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/blog/">Blog of James Brown</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/blog/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/blog/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/blog/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/blog/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
    <div class="content">
      

<!-- title -->
<div class="page-header page-header-inverse ">
  <h1 class="archive-title-tag title title-inverse ">Kubernetes</h1>
</div>

<div class="row page">
  <!-- cols -->
  
  <div class="col-md-9">
	

	  <div id="top_search"></div>

      
         <!-- display as entry -->
	     <div class="mypage">
	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-25 </div>
			<div class="article-title"><a href="/blog/2024/07/25/94f41044-8e20-4c0a-b388-a90698267758/" title="This article provides guidance on how to start a pod on a specific Kubernetes node using `nodeSelector`, `nodeName` in the pod manifest, and labeling nodes. It also explains how to use `kubectl run` with overrides to specify the desired node name for a pod.">Mastering Node Selection In Kubernetes With Nodeselector, Nodename, And Kubectl Run</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<h1 id="k8s-start-pod-at-specific-node"><a href="#k8s-start-pod-at-specific-node" class="headerlink" title="k8s start pod at specific node"></a>k8s start pod at specific node</h1><p>specify <code>nodeSelector</code> or <code>nodeName</code> in <code>Pod</code> or <code>VirtualMachineInstance</code> manifest</p>
<p>these selectors are in the <code>spec</code> field</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl run &lt;pod name&gt; --image=&lt;image name&gt; -it --<span class="built_in">rm</span> --overrides=<span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;nodeName&quot;: &quot;&lt;node name&gt;&quot;&#125;&#125;&#x27;</span> -- /bin/sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>to label a node, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node &lt;node_name&gt; &lt;key&gt;=&lt;value&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/blog/2024/07/25/94f41044-8e20-4c0a-b388-a90698267758/#more" class="btn btn-default more">Read More</a>
</div>

	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-24 </div>
			<div class="article-title"><a href="/blog/2024/07/24/a460b149-b6fe-4486-990f-4f638d127d85/" title="In Kubernetes, to reboot a pod or VM, you can either delete and recreate it to lose state or scale down the deployment&#39;s replicas for a soft-reboot. Additionally, you can use `virtctl` to manage VMs.">Rebooting A Pod Or Vm In Kubernetes: Deletion, Scaling Down, And Using Virtctl</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<h1 id="k8s-reboot-pod-and-vm"><a href="#k8s-reboot-pod-and-vm" class="headerlink" title="k8s reboot pod and vm"></a>k8s reboot pod and vm</h1><p>to reboot you need to kill the pod&#x2F;vmi and recreate it, thereby all its states will be lost.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod &lt;pod_name&gt;</span><br><span class="line">kubectl delete vmi &lt;vmi_name&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>for vmi there is an option called <code>soft-reboot</code> which is absent in pods. however the vm runner pod must not exit.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">virtctl soft-reboot &lt;vmi_name&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>for pod you you can scale down the replicas of deployment (recommended), or kill the pod directly.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment &lt;deployment_name&gt; --replicas=0</span><br><span class="line">kubectl scale deployment &lt;deployment_name&gt; --replicas=&lt;original replica num&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>for vm you are supposed to use <code>virtctl</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virtctl start &lt;vm_name&gt;</span><br><span class="line">virtctl stop &lt;vm_name&gt;</span><br><span class="line">virtctl restart &lt;vm_name&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/blog/2024/07/24/a460b149-b6fe-4486-990f-4f638d127d85/#more" class="btn btn-default more">Read More</a>
</div>

	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-24 </div>
			<div class="article-title"><a href="/blog/2024/07/24/39ca99f1-e47a-4b86-b113-a908bb03ef11/" title="This comprehensive guide provides detailed instructions on setting up a Kubernetes isolated pod proxy with Clash using tun mode, while ensuring restricted intranet access through NetworkPolicy. Additionally, it walks you through the process of creating a VPN, routing traffic via the VPN, and configuring Clash for an isolated proxy server.">Setting Up Isolated Pod Proxy With Clash And Vpn In Kubernetes</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<h1 id="k8s-isolated-pod-proxy-setup"><a href="#k8s-isolated-pod-proxy-setup" class="headerlink" title="k8s isolated pod proxy setup"></a>k8s isolated pod proxy setup</h1><p>you need to disable intranet access with <code>NetworkPolicy</code></p>
<p>find more info about intranet ranges here:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/langgenius/dify/blob/main/docker/ssrf_proxy/squid.conf.template">https://github.com/langgenius/dify/blob/main/docker/ssrf_proxy/squid.conf.template</a></p>
<p><a target="_blank" rel="noopener" href="http://www.squid-cache.org/Doc/config/acl/">http://www.squid-cache.org/Doc/config/acl/</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">deny-intranet-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">podSelector:</span></span><br><span class="line"><span class="attr">matchLabels:</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">policyTypes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"><span class="attr">egress:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line"><span class="attr">cidr:</span> <span class="string">::/0</span></span><br><span class="line"><span class="attr">except:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">fc00::/7</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">fe80::/10</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line"><span class="attr">cidr:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"><span class="attr">except:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/10</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">169.254</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>if you do not want to use <code>tun</code> routing and rely on application specific proxy adaptors, you can <code>export</code> environment variables at:</p>
<ul>
<li><p><code>/etc/profile</code> or <code>/etc/profile.d/proxy.sh</code></p>
</li>
<li><p><code>~/.bashrc</code></p>
</li>
</ul>
<hr>
<p>use clash tun mode by <code>config.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">interface-name:</span> <span class="string">en0</span> <span class="comment"># 与 `tun.auto-detect-interface` 冲突</span></span><br><span class="line"><span class="attr">tun:</span></span><br><span class="line"><span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">stack:</span> <span class="string">system</span> <span class="comment"># or gvisor</span></span><br><span class="line"><span class="comment"># dns-hijack:</span></span><br><span class="line"><span class="comment">#   - 8.8.8.8:53</span></span><br><span class="line"><span class="comment">#   - tcp://8.8.8.8:53</span></span><br><span class="line"><span class="comment">#   - any:53</span></span><br><span class="line"><span class="comment">#   - tcp://any:53</span></span><br><span class="line"><span class="attr">auto-route:</span> <span class="literal">true</span> <span class="comment"># manage `ip route` and `ip rules`</span></span><br><span class="line"><span class="attr">auto-redir:</span> <span class="literal">true</span> <span class="comment"># manage nftable REDIRECT</span></span><br><span class="line"><span class="attr">auto-detect-interface:</span> <span class="literal">true</span> <span class="comment"># 与 `interface-name` 冲突</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ref:</p>
<p><a target="_blank" rel="noopener" href="https://clash.wiki/premium/tun-device.html">https://clash.wiki/premium/tun-device.html</a></p>
<hr>
<p>by the most you would create a <code>tun</code> device, then route all traffic to the device after you have installed necessary softwares.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ip tuntap add mode tun dev tun0</span><br><span class="line">ip addr add 198.18.0.1/15 dev tun0</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev tun0 up</span><br><span class="line"><span class="comment"># download tun2socks</span></span><br><span class="line"><span class="comment"># https://github.com/xjasonlyu/tun2socks</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>you need to use the default gateway otherwise you will not be able to reach the dns.</p>
<p>the default gateway will differ from nodes. it is recommended to fetch it from <code>ip route</code></p>
<p>for ubuntu containers you would run <code>apt install iproute2</code> first</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DNS_IP=8.8.8.8</span><br><span class="line">GATEWAY_IP=$(ip route | grep default | grep -oE <span class="string">&quot;\b([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;\b&quot;</span>)</span><br><span class="line">DEFAULT_ROUTE=$(ip route | grep default | sed -E <span class="string">&#x27;s/( metric.*)?$/ metric 100/g;&#x27;</span>)</span><br><span class="line">DEFAULT_NET_DEVICE=$(ip route | grep default | grep -oP <span class="string">&#x27;(?&lt;=dev )\w+&#x27;</span>)</span><br><span class="line"><span class="comment"># run with root privilege</span></span><br><span class="line">ip route delete default</span><br><span class="line">ip route add <span class="variable">$DEFAULT_ROUTE</span></span><br><span class="line">ip route add default dev via 198.18.0.1 tun0</span><br><span class="line">ip route add <span class="variable">$DNS_IP</span> via <span class="variable">$GATEWAY_IP</span> dev <span class="variable">$DEFAULT_NET_DEVICE</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>then launch <code>tun2socks</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./tun2socks -interface <span class="variable">$DEFAULT_NET_DEVICE</span> -device tun://tun0 -proxy &lt;proxy_protocol&gt;://&lt;proxy_address&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>to disable the tun network you can run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip route delete default dev tun0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>you need to configure the <code>dnsPolicy</code> to <code>None</code> in manifest otherwise it would add the cluster dns ip to <code>/etc/resolv.conf</code>, slowing down the lookup process and making it very hard to change during the runtime.</p>
<p>not every domain shall be reached via public proxies, unless it is graranteed to not be discovered by the gfw.</p>
<p>the full network isolation scheme can be shown below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">internet interface</span><br><span class="line">|</span><br><span class="line">intranet-isolated proxy server (hysteria)</span><br><span class="line">|</span><br><span class="line">cluster service with clusterIP</span><br><span class="line">|</span><br><span class="line">isolated socks5 server with only access</span><br><span class="line">to the hysteria service clusterIP and port</span><br><span class="line">|</span><br><span class="line">local socks5 service with clusterIP</span><br><span class="line">|</span><br><span class="line">isolated tun-routed pod with only access</span><br><span class="line">to socks5 service clusterIP and port</span><br><span class="line"></span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/blog/2024/07/24/39ca99f1-e47a-4b86-b113-a908bb03ef11/#more" class="btn btn-default more">Read More</a>
</div>

	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-24 </div>
			<div class="article-title"><a href="/blog/2024/07/24/287e1737-26f8-4db2-867c-6bf4a900940b/" title="This article outlines the steps and considerations for installing Kubevirt, a virtual machine platform built on Kubernetes. It covers crucial components, installation procedures, and compatibility considerations when using Microk8s as the underlying Kubernetes distribution.">Installing And Configuring Kubevirt On Microk8S</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<h1 id="install-kubevirt"><a href="#install-kubevirt" class="headerlink" title="install kubevirt"></a>install kubevirt</h1><p>do not install it on microk8s</p>
<hr>
<p>install windows on kubevirt:</p>
<p><a target="_blank" rel="noopener" href="https://charlottemach.com/2020/11/03/windows-kubevirt-k3s.html">https://charlottemach.com/2020/11/03/windows-kubevirt-k3s.html</a></p>
<hr>
<p><code>VirtualMachine</code> is like <code>Deployment</code> while <code>VirtualMachineInstance</code> is like <code>Pod</code></p>
<hr>
<p>export kubeconfig file path to <code>~/.bashrc</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=&lt;kubeconfig_filepath&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>download and modify the manifests</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prefer ustc and azure mirrors of quay.io</span></span><br><span class="line"><span class="built_in">export</span> VERSION=$(curl -s https://api.github.com/repos/kubevirt/kubevirt/releases | grep tag_name | grep -v -- <span class="string">&#x27;-rc&#x27;</span> | <span class="built_in">head</span> -1 | awk -F<span class="string">&#x27;: &#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | sed <span class="string">&#x27;s/,//&#x27;</span> | xargs)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$VERSION</span></span><br><span class="line">curl -OLk https://github.com/kubevirt/kubevirt/releases/download/<span class="variable">$&#123;VERSION&#125;</span>/kubevirt-operator.yaml</span><br><span class="line">curl -OLk https://github.com/kubevirt/kubevirt/releases/download/<span class="variable">$&#123;VERSION&#125;</span>/kubevirt-cr.yaml</span><br><span class="line"><span class="built_in">export</span> VERSION=$(curl -s https://api.github.com/repos/kubevirt/containerized-data-importer/releases | grep tag_name | grep -v -- <span class="string">&#x27;-rc&#x27;</span> | <span class="built_in">head</span> -1 | awk -F<span class="string">&#x27;: &#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | sed <span class="string">&#x27;s/,//&#x27;</span> | xargs)</span><br><span class="line">curl -LkO https://ghproxy.net/github.com/kubevirt/containerized-data-importer/releases/download/<span class="variable">$VERSION</span>/cdi-operator.yaml</span><br><span class="line">curl -LkO https://ghproxy.net/github.com/kubevirt/containerized-data-importer/releases/download/<span class="variable">$VERSION</span>/cdi-cr.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>check if it works</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kubevirt</span><br><span class="line">kubectl get vmi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>install virtctl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get the download address from: https://github.com/kubevirt/kubevirt/releases/</span></span><br><span class="line">curl -LkO &lt;download_address&gt;</span><br><span class="line">sudo <span class="built_in">mv</span> &lt;downloaded_binary&gt; /usr/bin/virtctl</span><br><span class="line">sudo <span class="built_in">chmod</span> +x /usr/bin/virtctl</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>create vm (already with tun device inside)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init_vm.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubevirt.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualMachine</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&lt;vm_name&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">runStrategy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">dnsConfig:</span></span><br><span class="line"><span class="attr">nameservers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="attr">domain:</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="attr">requests:</span></span><br><span class="line"><span class="attr">memory:</span> <span class="string">1024M</span></span><br><span class="line"><span class="attr">devices:</span></span><br><span class="line"><span class="attr">disks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">containerdisk</span></span><br><span class="line"><span class="attr">disk:</span></span><br><span class="line"><span class="attr">bus:</span> <span class="string">virtio</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydisk</span></span><br><span class="line"><span class="attr">disk:</span></span><br><span class="line"><span class="attr">bus:</span> <span class="string">virtio</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">disk:</span></span><br><span class="line"><span class="attr">bus:</span> <span class="string">virtio</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">cloudinitdisk</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">containerdisk</span></span><br><span class="line"><span class="attr">containerDisk:</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">kubevirt/fedora-cloud-container-disk-demo:latest</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydisk</span></span><br><span class="line"><span class="attr">emptyDisk:</span></span><br><span class="line"><span class="attr">capacity:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudinitdisk</span></span><br><span class="line"><span class="attr">cloudInitNoCloud:</span></span><br><span class="line"><span class="attr">userData:</span> <span class="string">|-</span></span><br><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="attr">password:</span> <span class="string">fedora</span></span><br><span class="line"><span class="attr">chpasswd:</span> &#123; <span class="attr">expire:</span> <span class="literal">False</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>apply it to run the vm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f init_vm.yaml</span><br><span class="line">kubectl get vm</span><br><span class="line">kubectl get vmi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>to interact with the vm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">virtctl console &lt;vm_name&gt;</span><br><span class="line"><span class="comment"># ssh config is stored at: ~/.ssh/kube_known_hosts</span></span><br><span class="line">virtctl ssh &lt;user&gt;@&lt;vm_name&gt;</span><br><span class="line"><span class="comment"># run this under gui, with `vncviewer` in path</span></span><br><span class="line"><span class="comment"># install with `apt install tigervnc-viewer`</span></span><br><span class="line">virtctl vnc &lt;vm_name&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/blog/2024/07/24/287e1737-26f8-4db2-867c-6bf4a900940b/#more" class="btn btn-default more">Read More</a>
</div>

	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-21 </div>
			<div class="article-title"><a href="/blog/2024/07/21/cf60c137-bc18-49af-9985-080e62ba10e8/" title="This article provides a detailed guide on installing the official Kubernetes Python library, setting up configuration paths, and showcasing its usage through code examples. It also includes an example of listing pods&#39; IP addresses across different namespaces using CoreV1Api.">Mastering Kubernetes Python Library: Installation, Configuration, And Pods Listing Examples</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<h1 id="k8s-python-api-library"><a href="#k8s-python-api-library" class="headerlink" title="k8s python api library"></a>k8s python api library</h1><p>install the official library with <code>pip install kubernetes</code></p>
<hr>
<p>the default api config path for k8s is at <code>~/.kube/config</code></p>
<p><code>k3s</code> is at <code>/etc/rancher/k3s/k3s.yaml</code></p>
<p><code>microk8s</code> is at <code>/var/snap/microk8s/current/credentials/kubelet.config</code></p>
<p>you can also set <code>KUBECONFIG</code> environment variable to let <code>kubernetes</code> python library know where the config is</p>
<hr>
<p>to use it:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-client/python/blob/master/kubernetes/README.md">https://github.com/kubernetes-client/python/blob/master/kubernetes/README.md</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> kubernetes <span class="keyword">import</span> client, config</span><br><span class="line"><span class="comment"># Configs can be set in Configuration class directly or using helper utility</span></span><br><span class="line">config_path = ...</span><br><span class="line">config.load_kube_config(config_path)</span><br><span class="line">v1 = client.CoreV1Api()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Listing pods with their IPs:&quot;</span>)</span><br><span class="line">ret = v1.list_pod_for_all_namespaces(watch=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ret.items:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;%s\t%s\t%s&quot;</span> % (i.status.pod_ip, i.metadata.namespace, i.metadata.name))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/blog/2024/07/21/cf60c137-bc18-49af-9985-080e62ba10e8/#more" class="btn btn-default more">Read More</a>
</div>

	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-21 </div>
			<div class="article-title"><a href="/blog/2024/07/21/a69fab8e-7e2a-4fac-a632-dc730f339eca/" title="This article focuses on Kubernetes (k8s) security, offering resources for understanding how to secure a Kubernetes cluster. It references the Snyk IoT guide and official Kubernetes documentation as valuable learning materials.">K8S Security</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://snyk.io/learn/kubernetes-security/">https://snyk.io/learn/kubernetes-security/</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/securing-a-cluster/">https://kubernetes.io/docs/tasks/administer-cluster/securing-a-cluster/</a></p>

	
	</div>
  <a type="button" href="/blog/2024/07/21/a69fab8e-7e2a-4fac-a632-dc730f339eca/#more" class="btn btn-default more">Read More</a>
</div>

	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-21 </div>
			<div class="article-title"><a href="/blog/2024/07/21/7e278413-28ba-4422-8cd1-1145ab1c2f2c/" title="This article provides a comprehensive guide on building, uploading, and loading Docker images for Kubernetes-based microk8s or Minikube. Additionally, it covers the process of importing images specifically for lightweight K3s distribution that utilizes the Docker container runtime.">K8S Load Docker Image</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<p>first of all, you can build and upload docker image to registry.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br><span class="line">docker build -t &lt;username&gt;/&lt;imagename&gt;:&lt;tag&gt; -f &lt;dockerfile&gt; &lt;resource_path&gt;</span><br><span class="line">docker push &lt;username&gt;/&lt;imagename&gt;:&lt;tag&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>you can upload to docker.io or microk8s provided local registry.</p>
<p><a target="_blank" rel="noopener" href="https://microk8s.io/docs/registry-built-in">https://microk8s.io/docs/registry-built-in</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for microk8s the registry address is localhost:32000</span></span><br><span class="line">docker tag &lt;imagename&gt; &lt;registry_addr&gt;/&lt;imagename&gt;</span><br><span class="line">docker push &lt;registry_addr&gt;/&lt;imagename&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>you can also build image with minikube:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">minikube image build -t &lt;imagename&gt; -f &lt;dockerfile_path&gt; &lt;resource_path&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>load image exported with <code>docker save &lt;image&gt;:&lt;tag&gt;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ref: https://minikube.sigs.k8s.io/docs/commands/image/</span></span><br><span class="line"><span class="comment"># remember to set a tag to the image imported</span></span><br><span class="line"><span class="comment"># or set the imagePullPolicy to Never</span></span><br><span class="line"><span class="comment"># ref: https://iximiuz.com/en/posts/kubernetes-kind-load-docker-image/</span></span><br><span class="line">minikube image load &lt;image_filepath&gt;/&lt;docker_image_name&gt;</span><br><span class="line">microk8s images import &lt;image_filepath&gt;</span><br><span class="line">microk8s ctr image import &lt;image_filepath&gt;</span><br><span class="line">k3s ctr image import &lt;image_filepath&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.scottlowe.org/2020/01/25/manually-loading-container-images-with-containerd/">https://blog.scottlowe.org/2020/01/25/manually-loading-container-images-with-containerd/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/installation/registry-mirror#pushing-images">https://docs.k3s.io/installation/registry-mirror#pushing-images</a></p>
<hr>
<p>you can also configure k8s to use docker as container runtime instead.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/canonical/microk8s/issues/287">https://github.com/canonical/microk8s/issues/287</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/advanced#using-docker-as-the-container-runtime">https://docs.k3s.io/advanced#using-docker-as-the-container-runtime</a></p>

	
	</div>
  <a type="button" href="/blog/2024/07/21/7e278413-28ba-4422-8cd1-1145ab1c2f2c/#more" class="btn btn-default more">Read More</a>
</div>

	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-20 </div>
			<div class="article-title"><a href="/blog/2024/07/20/5f4542dd-3492-4971-86e0-43210ce66510/" title="This article discusses the importance of securing Kubernetes and managing resources using distribution-specific methods. It also covers preventing intranet access through network policies, and considering manual/automatic cleanup for storage limits. Hardening guidelines are followed, and additional resources are provided for further information on available tools.">K8S Deny Intranet Access From All Containers</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<p>constrain pod resources:</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/</a></p>
<hr>
<p>to manually exceed the ephermal storage limit run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fallocate -l 10G /bigfile</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>the pod will be evicted, volume and container will be purged, but the record is not automatically removed.</p>
<p>to cleanup the mess one may run a scheduled job like:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">microk8s kubectl delete pods --field-selector=status.phase=Failed</span><br><span class="line">microk8s kubectl delete pods --field-selector=status.phase=Unknown</span><br><span class="line"><span class="built_in">sleep</span> 60</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>or configure implementation dependent <code>kube-controller-manager</code> startup argument <code>terminated-pod-gc-threshold=1</code>.</p>
<p>for <code>k3s</code> edit <code>/etc/rancher/k3s/config.yaml</code> like:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kube-controller-manager-arg:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&#x27;terminated-pod-gc-threshold=1&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>for <code>microk8s</code>, edit <code>/var/snap/microk8s/current/args/kube-controller-manager</code></p>
<p>references:</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/">https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/security/hardening-guide">https://docs.k3s.io/security/hardening-guide</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/k3s-io/k3s/issues/10448">https://github.com/k3s-io/k3s/issues/10448</a></p>
<hr>
<p>make sure you have a networkpolicy enabled cni first. usually included but be careful with minikube since that is a different story</p>
<p>apply these configs with <code>kubectl apply -f &lt;config_path&gt;</code></p>
<p>interact with <code>kubectl exec &lt;pod_name&gt; -it -- /bin/sh</code></p>
<p>deployment config:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line"><span class="attr">matchLabels:</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine-container</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">alpine:3.7</span></span><br><span class="line"><span class="attr">command:</span> [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="attr">limits:</span></span><br><span class="line"><span class="attr">ephemeral-storage:</span> <span class="string">&quot;4Gi&quot;</span></span><br><span class="line"><span class="attr">dnsPolicy:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">dnsConfig:</span></span><br><span class="line"><span class="attr">nameservers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>network policy config:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">deny-intranet-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">podSelector:</span></span><br><span class="line"><span class="attr">matchLabels:</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">policyTypes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"><span class="attr">egress:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line"><span class="attr">cidr:</span> <span class="string">::/0</span></span><br><span class="line"><span class="attr">except:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">fc00::/7</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">fe80::/10</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line"><span class="attr">cidr:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"><span class="attr">except:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/10</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">169.254</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/blog/2024/07/20/5f4542dd-3492-4971-86e0-43210ce66510/#more" class="btn btn-default more">Read More</a>
</div>

	       
		     
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2024-07-19 </div>
			<div class="article-title"><a href="/blog/2024/07/19/32f77638-8d8b-4c48-9ecb-a519adfc6fbe/" title="This guide walks you through installing lightweight Kubernetes clusters, either microk8s or k0s. It covers enabling DNS and multiple registries, provides recommendations for mirror sites in different regions, offers runtime configurations, and gives troubleshooting tips to ensure a smooth setup process.">Install Microk8S</a></div>
		</h3>
	


		     
<div class="entry">

  <div class="row">
	
	
		<p>network policy:</p>
<p><a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/handbook/network_policy/">https://minikube.sigs.k8s.io/docs/handbook/network_policy/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/network-policy/get-started/calico-policy/calico-network-policy">https://docs.tigera.io/calico/latest/network-policy/get-started/calico-policy/calico-network-policy</a></p>
<p>persistent volume:</p>
<p><a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/handbook/persistent_volumes/">https://minikube.sigs.k8s.io/docs/handbook/persistent_volumes/</a></p>
<hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo snap install --classic microk8s</span><br><span class="line">sudo microk8s <span class="built_in">enable</span> dns:&lt;dns_ip&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>config files are at <code>/var/snap/microk8s/current</code>, and you need to replace all <code>docker.io</code> with some docker mirror to prevent init errors.</p>
<p>run <code>microk8s inspect</code> to get errors like hostname casing, and missing file like <code>/var/snap/microk8s/current/var/kubernetes/backend/localnode.yaml</code></p>
<p>you need to configure multiple registries for <code>docker.io</code> and <code>registry.k8s.io</code> under <code>/var/snap/microk8s/current/args/certs.d</code></p>
<p>in order to use some mirror site which does not support <code>/v2</code> url, you have to add <code>override_path = true</code> in config</p>
<p>mirror sites:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/docker-mirrors/website">https://github.com/docker-mirrors/website</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/cmliu/CF-Workers-docker.io/issues/8">https://github.com/cmliu/CF-Workers-docker.io/issues/8</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubesre/docker-registry-mirrors">https://github.com/kubesre/docker-registry-mirrors</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lawrenceching/gitbook/blob/master/docker-repositories-in-china.md">https://github.com/lawrenceching/gitbook/blob/master/docker-repositories-in-china.md</a></p>
<p>reference:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/blob/main/docs/hosts.md">https://github.com/containerd/containerd/blob/main/docs/hosts.md</a></p>
<p><a target="_blank" rel="noopener" href="https://microk8s.io/docs/registry-private">https://microk8s.io/docs/registry-private</a></p>
<hr>
<p>install k3s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://get.k3s.io &gt; k3s_setup.sh</span><br><span class="line"><span class="comment"># replace the line if GITHUB_URL to some github mirror instead</span></span><br><span class="line">bash k3s_setup.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>k3s mirror</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -​</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>registry config:</p>
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/installation/private-registry">https://docs.k3s.io/installation/private-registry</a></p>
<hr>
<p>k0s install:</p>
<p><a target="_blank" rel="noopener" href="https://docs.k0sproject.io/stable/install/">https://docs.k0sproject.io/stable/install/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -sSLf https://get.k0s.sh | sudo sh</span><br><span class="line">sudo k0s install controller --single</span><br><span class="line">sudo k0s start</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>config:</p>
<p><a target="_blank" rel="noopener" href="https://docs.k0sproject.io/stable/runtime/">https://docs.k0sproject.io/stable/runtime/</a></p>

	
	</div>
  <a type="button" href="/blog/2024/07/19/32f77638-8d8b-4c48-9ecb-a519adfc6fbe/#more" class="btn btn-default more">Read More</a>
</div>

	       
	     </div>
	     <div>
	       <center>
	         <div class="pagination">
<ul class="pagination">
	 
</ul>
</div>

	       </center>
	     </div>	
      

</div> <!-- col-md-9/col-md-12 -->


<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/james4ever0/agi_computer_control/" title="Autonomous computer agent" target="_blank"]);">Project Cybergod</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/james4ever0/pyjom/" title="Media content automation" target="_blank"]);">Project Pyjom</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/james4ever0/prometheous/" title="Automated documentation, AI+IR(RAG)" target="_blank"]);">Project Prometheus</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/james4ever0/pyjom/" title="Media Content Automation" target="_blank"]);">Project Pyjom</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/james4ever0/my_blog_source/" title="Source code of my blog"" target="_blank"]);">Blog Source Code</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/james4ever0" title="My Github account" target="_blank"]);">My Github</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://samoyedsun.github.io/" title="Samoyedsun's Blog" target="_blank"]);">Samoyedsun&#39;s Blog</a></li>
	
		<li><i class="fa fa-book"></i><a href="http://atlant1c.cn/" title="Atlant1c's Blog" target="_blank"]);">Atlant1c&#39;s Blog</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://www.gregoryuan.com/" title="Gregoryuan's Blog" target="_blank"]);">Gregoryuan&#39;s Blog</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://yubingtao.netlify.app/" title="Yubingtao's Blog" target="_blank"]);">Yubingtao&#39;s Blog</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->




    </div>
  </div>
  <div class="container-narrow">
    <footer> <p>
  &copy; 2024 James Brown
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
  </div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/blog/js/jquery.imagesloaded.min.js"></script>
<script src="/blog/js/gallery.js"></script>
<script src="/blog/js/bootstrap.min.js"></script>
<script src="/blog/js/main.js"></script>
<script src="/blog/js/search.js"></script> 


<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/blog/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/blog/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- syntax highlighting -->


</body>
</html>